#!/usr/bin/env ansible-playbook
# File: .setup_project.yml
# GitHub: https://github.com/makeitworkcloud/ansible-project-libvirt
# Description: Creates the libvirt project in AWX.
# Author:
#                                   _|
#   _|    _|  _|_|_|      _|_|    _|_|_|_|    _|_|
#     _|_|    _|    _|  _|    _|    _|      _|    _|
#   _|    _|  _|    _|  _|    _|    _|      _|    _|
#   _|    _|  _|    _|    _|_|        _|_|    _|_|
---
- name: Load SOPS secrets
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Load SOPS secrets
      community.sops.load_vars:
        file: secrets/secrets.yaml

- name: Deploy AWX content
  hosts: localhost
  gather_facts: false
  vars:
    awx_project_name: libvirt
    awx_organization: Default
  module_defaults:
    group/awx.awx.controller:
      controller_host: "{{ controller_host }}"
      controller_username: "{{ controller_username }}"
      controller_password: "{{ controller_password }}"
      validate_certs: true
  tasks:
    - name: Create project
      awx.awx.project:
        name: "{{ awx_project_name }}"
        description: "Managed by ansible-project-libvirt"
        organization: "{{ awx_organization }}"
        scm_type: git
        scm_url: https://github.com/makeitworkcloud/ansible-project-libvirt.git
        scm_update_on_launch: false
        state: present

    - name: Sync project
      awx.awx.project_update:
        name: "{{ awx_project_name }}"
        wait: true
        timeout: 300
      when: not ansible_check_mode

    - name: Create inventory
      awx.awx.inventory:
        name: "{{ awx_project_name }}"
        description: "Managed by ansible-project-libvirt"
        organization: "{{ awx_organization }}"
        state: present

    - name: Add libvirt host to inventory
      awx.awx.host:
        name: "{{ libvirt_host }}"
        inventory: "{{ awx_project_name }}"
        variables:
          ansible_host: "{{ libvirt_fqdn }}"
        state: present

    - name: Create SSH credential
      awx.awx.credential:
        name: "{{ awx_project_name }} SSH"
        description: "SSH key for libvirt host"
        organization: "{{ awx_organization }}"
        credential_type: Machine
        inputs:
          username: "{{ libvirt_ssh_user }}"
          ssh_key_data: "{{ libvirt_ssh_private_key }}"
        state: present

    - name: Create Vault credential
      awx.awx.credential:
        name: "{{ awx_project_name }} Vault"
        description: "Ansible Vault password"
        organization: "{{ awx_organization }}"
        credential_type: Vault
        inputs:
          vault_password: "{{ vault_password }}"
        state: present

    - name: Find playbooks
      ansible.builtin.find:
        paths: playbooks/
        patterns: "*.yml,*.yaml"
        file_type: file
        recurse: false
      register: found_playbooks

    - name: Create job templates
      awx.awx.job_template:
        name: "{{ item.path | basename | regex_replace('\\.ya?ml$', '') }}"
        description: "Job template for {{ item.path | basename }}"
        organization: "{{ awx_organization }}"
        project: "{{ awx_project_name }}"
        inventory: "{{ awx_project_name }}"
        playbook: "playbooks/{{ item.path | basename }}"
        job_type: run
        credentials:
          - "{{ awx_project_name }} SSH"
          - "{{ awx_project_name }} Vault"
        state: present
      loop: "{{ found_playbooks.files }}"
      loop_control:
        label: "{{ item.path | basename }}"
